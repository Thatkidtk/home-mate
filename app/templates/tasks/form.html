{% extends "base.html" %}
{% block content %}
<div class="col-12 col-lg-8 mx-auto">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">{{ 'Edit' if task else 'Create' }} Task</h1>
    <a class="btn btn-outline-secondary" href="{{ url_for('tasks.list_tasks') }}">Back</a>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" class="row g-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="col-12 form-floating">
          <select class="form-select" name="asset_id" id="asset_id" required>
            {% for a in assets %}
              <option value="{{ a.id }}" {% if task and a.id==task.asset_id %}selected{% endif %}>{{ a.name }}</option>
            {% endfor %}
          </select>
          <label for="asset_id">Asset</label>
        </div>
        <div class="col-12 form-floating">
          <input class="form-control" name="title" id="title" placeholder="Title" value="{{ task.title if task else '' }}" required>
          <label for="title">Title</label>
        </div>
        <div class="col-12 form-floating">
          <textarea class="form-control" name="description" id="description" style="height: 120px;" placeholder="Description">{{ task.description if task else '' }}</textarea>
          <label for="description">Description</label>
        </div>
        <div class="col-md-6 form-floating">
          <input type="date" class="form-control" name="due_date" id="due_date" placeholder="Due date" value="{{ task.due_date.isoformat() if task and task.due_date else '' }}">
          <label for="due_date">Due date</label>
        </div>
        <div class="col-md-6 form-floating">
          <input class="form-control" name="recurrence_rule" id="recurrence_rule" placeholder="Recurrence rule" value="{{ task.recurrence_rule if task else '' }}">
          <label for="recurrence_rule">Recurrence (RRULE)</label>
          <div class="form-text">Example: FREQ=MONTHLY;INTERVAL=3</div>
        </div>
        <div class="col-md-6 form-floating">
          <input type="number" class="form-control" name="priority" id="priority" placeholder="Priority" value="{{ task.priority if task else 0 }}">
          <label for="priority">Priority</label>
        </div>
        <div class="col-md-6 form-floating">
          <input type="number" class="form-control" name="estimated_minutes" id="estimated_minutes" placeholder="Estimated minutes" value="{{ task.estimated_minutes if task else 0 }}">
          <label for="estimated_minutes">Estimated minutes</label>
        </div>
        <div class="col-md-6 form-floating">
          <input type="number" step="0.01" class="form-control" name="cost" id="cost" placeholder="Cost" value="{{ task.cost if task and task.cost else '' }}">
          <label for="cost">Cost</label>
        </div>
        <div class="col-md-6 form-floating">
          <input class="form-control" name="vendor" id="vendor" placeholder="Vendor" value="{{ task.vendor if task else '' }}">
          <label for="vendor">Vendor</label>
        </div>
        <div class="col-12 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Save</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('tasks.list_tasks') }}">Cancel</a>
        </div>
      </form>
    </div>
  </div>

  {% if task %}
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h6 mb-0">Attachments</h2>
          <form method="post" action="{{ url_for('tasks.upload_attachment', task_id=task.id) }}" enctype="multipart/form-data" class="d-flex gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input class="form-control form-control-sm" type="file" name="file" required>
            <button class="btn btn-sm btn-outline-primary" type="submit"><i class="bi bi-upload me-1"></i>Upload</button>
          </form>
        </div>
        {% if task.attachments %}
          <div class="row g-3">
            {% for att in task.attachments %}
              <div class="col-sm-6 col-lg-4">
                <div class="border rounded p-2 d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">{{ att.original_name or att.key }}</div>
                    <div class="text-secondary small">{{ att.mime or "file" }} Â· {{ ((att.size or 0) / 1024)|round(1) }} KB</div>
                  </div>
                  <div class="btn-group">
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('files.get_attachment', attachment_id=att.id) }}">Open</a>
                    <form method="post" action="{{ url_for('tasks.delete_attachment', attachment_id=att.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn-sm btn-outline-danger" type="submit">&times;</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-secondary mb-0">No attachments yet.</p>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
